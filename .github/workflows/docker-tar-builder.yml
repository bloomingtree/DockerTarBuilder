name: Docker Image Tar Builder

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Docker 镜像名称 (例如: nginx:latest, mysql:8.0)'
        required: true
        type: string
      output_filename:
        description: '输出文件名 (不含扩展名，默认使用镜像名)'
        required: false
        type: string

jobs:
  pull-and-push:
    name: Pull and Push Docker Image
    runs-on: ubuntu-latest
    environment: docker-tar-builder
    outputs:
      image_tag: ${{ steps.meta.outputs.image_tag }}
      tar_filename: ${{ steps.meta.outputs.tar_filename }}
    steps:
      - name: Prepare metadata
        id: meta
        run: |
          # 处理镜像名称，替换特殊字符
          IMAGE_NAME="${{ inputs.image_name }}"
          SAFE_NAME=$(echo "$IMAGE_NAME" | tr '/:' '-')
          
          # 输出文件名
          if [ -n "${{ inputs.output_filename }}" ]; then
            TAR_FILENAME="${{ inputs.output_filename }}.tar.gz"
          else
            TAR_FILENAME="${SAFE_NAME}.tar.gz"
          fi
          
          # 目标镜像标签
          IMAGE_TAG="${{ vars.DOCKER_REGISTRY }}/${{ vars.DOCKER_IMAGE_NAME }}:${SAFE_NAME}"
          
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "tar_filename=${TAR_FILENAME}" >> $GITHUB_OUTPUT
          echo "原始镜像: $IMAGE_NAME"
          echo "目标镜像: $IMAGE_TAG"
          echo "输出文件: $TAR_FILENAME"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ vars.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull Docker image
        run: |
          echo "正在拉取镜像: ${{ inputs.image_name }}"
          docker pull ${{ inputs.image_name }}

      - name: Tag and push to Registry
        run: |
          docker tag ${{ inputs.image_name }} ${{ steps.meta.outputs.image_tag }}
          echo "正在推送镜像到: ${{ steps.meta.outputs.image_tag }}"
          docker push ${{ steps.meta.outputs.image_tag }}

  export-on-server:
    name: Export Image on Server
    runs-on: ubuntu-latest
    needs: pull-and-push
    environment: docker-tar-builder
    steps:
      - name: Pull and export on remote server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            
            # 配置
            IMAGE_TAG="${{ needs.pull-and-push.outputs.image_tag }}"
            TAR_FILENAME="${{ needs.pull-and-push.outputs.tar_filename }}"
            OUTPUT_DIR="${{ vars.OUTPUT_DIR }}"
            
            # 默认输出目录
            if [ -z "$OUTPUT_DIR" ]; then
              OUTPUT_DIR="/tmp/docker-images"
            fi
            
            echo "=========================================="
            echo "镜像: $IMAGE_TAG"
            echo "输出目录: $OUTPUT_DIR"
            echo "文件名: $TAR_FILENAME"
            echo "=========================================="
            
            # 创建输出目录
            mkdir -p "$OUTPUT_DIR"
            
            # 登录 Docker Registry
            echo "正在登录 Docker Registry..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | docker login ${{ vars.DOCKER_REGISTRY }} -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
            
            # 拉取镜像
            echo "正在拉取镜像..."
            docker pull "$IMAGE_TAG"
            
            # 导出为 tar.gz
            echo "正在导出镜像..."
            docker save "$IMAGE_TAG" | gzip > "$OUTPUT_DIR/$TAR_FILENAME"
            
            # 清理登录状态
            docker logout ${{ vars.DOCKER_REGISTRY }}
            
            echo "=========================================="
            echo "导出完成!"
            echo "文件位置: $OUTPUT_DIR/$TAR_FILENAME"
            ls -lh "$OUTPUT_DIR/$TAR_FILENAME"
            echo "=========================================="
